<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">

<link rel="import" href="../ace-widget/ace-widget.html">

<link rel="import" href="../warp10-iron/warp10-warpscript-caller.html">
<link rel="import" href="../warp10-iron/warp10-gts-tools.html">
<link rel="import" href="../warp10-iron/warp10-simple-overlay.html">

<link rel="import" href="../warp10-quantum/quantum-external-deps.html">
<link rel="import" href="../warp10-quantum/warp10-response-container.html">
<link rel="import" href="../warp10-quantum/warp10-warpscript-permalink.html">

<script src="../warp10-quantum/ace/mode-warpscript.js"></script>
<script src="../ace-builds/src-min-noconflict/theme-eclipse.js"></script>
<script src="../ace-builds/src-min-noconflict/snippets/text.js"></script>

<dom-module id="warp10-warpscript-ide">
  <style>
    :host {
      display: block;
    }
    .ace-editor {
      font-size: 14px;
    }
    .top-10 { margin-top:10px; }

    .left {
      float: left;
    }
    .right {
      float: right;
    }
    .btn[hidden],
    warp10-warpscript-permalink-generator[hidden],
    warp10-response-container[hidden] {
      display: none;
    }
    .overlayBox {
      display:flex;
      flex-flow: row;
      justify-content: center;
      font-size: 1.2em;
    }
    .overlayContent  {
    }
    .hotkey-key {
      background-color: #333;
      border: 1px solid #333;
      border-radius: 5px;
      box-shadow: 0 1px 0 #666 inset, 0 1px 0 #bbb;
      color: #fff;
      display: inline-block;
      font-size: 1em;
      margin-right: 5px;
      padding: 5px 9px;
      text-align: center;
    }
  </style>
  <template>

    <iron-a11y-keys target="[[target]]" keys="e" on-keys-pressed="hotkeyExecute"></iron-a11y-keys>
    <iron-a11y-keys target="[[target]]" keys="p" on-keys-pressed="hotkeyPlot"></iron-a11y-keys>
    <iron-a11y-keys target="[[target]]" keys="h ?:keypress" on-keys-pressed="hotkeyHelp"></iron-a11y-keys>
    <warp10-simple-overlay id="warpscript-ide-keyboard-shortcuts-overlay">
      <div class="overlay-box">
        <h4>Keyboard Shortcuts:</h4>
        <p><span class="hotkey-key">?</span> Show / hide this help menu</p>
        <p><span class="hotkey-key">e</span> Execute WarpScript</p>
        <p><span class="hotkey-key">p</span> Plot result</p>
      </div>
    </warp10-simple-overlay>

    <warp10-warpscript-caller
      id="warpscriptcaller"
      url="{{_baseUrl}}" warpscript="{{warpscriptScript}}"
      on-response="_handleResponse"  on-error="_handleError"
      loading="{{loading}}">
    </warp10-warpscript-caller>


    <ace-widget
      id="editor" theme="ace/theme/eclipse" mode="ace/mode/warpscript"
      softtabs="true" wrap="true" value="{{content}}">Type your code here... </ace-widget>


    <spinner-widget active="{{loading}}" hover size="200" ></spinner-widget>


    <warp10-warpscript-permalink-generator
      warpscript="{{content}}" backend="{{backend}}" hidden$="{{hidePermalink}}"></warp10-warpscript-permalink-generator>

    <div  class="top-10">
      <template is="dom-if" if="{{!hidePlot}}">
        <div class="left">
          <button
            class="btn btn-primary btn-lg"
            on-click="doPlot"
            disabled$="{{loading}}"
            hidden$="{{!_hasAResponse}}">
            Plot
          </button>
        </div>
      </template>
      <div class="right">
        <button
          id="btn_execute"
          class="btn btn-primary btn-lg"
          on-click="execute"
          disabled$="{{loading}}">
          Execute!
        </button>
      </div>
    </div>
    <template is="dom-if" if="{{showedElapsedTime}}">
      <div class="clearfix"> </div>
      <div  class="top-10">
        <div class="right">Your script execution took {{formattedElapsedTime}} serverside</div>
      </div>
    </template>
    <div class="clearfix"> </div>


    <div  class="top-10">
      <warp10-response-container
        id="response_container"
        response="{{stack}}"
        received="{{received}}" 
        hidden$="{{!_hasAResponse}}">></warp10-response-container>
      <div class="alert alert-danger" hidden$="{{!_hasAnError}}">
        {{errorMsg}}
      </div>
    </div>


  </template>
</dom-module>

<script>
  Polymer({
    is:"warp10-warpscript-ide",
    properties: {
      content: {
        type: String,
        notify: true
      },
      backend: {
        type: String,
        value: "http://127.0.0.1:8080/api/v0"
      },
      /**
       * The  exec endpoint
       */
      execEndpoint: {
        type: String,
        value: "/exec"
      },
      response: {
        type: Array,
        value: function() {
          return null;
        }
      },
      plot: {
        type: Number,
        value: 0,
        notify: true
      },
      data: {
        type: Array,
        notify: true
      },
      target: {
        type: Object,
        value: function() {
          return document.body;
        }
      },
      /**
       * Elapsed time for the call
       */
      elapsed: {
        type: Number,
        value: -1
      },
      /**
       * Elapsed time for the call, formated for view
       */
      formattedElapsedTime: {
        type: String,
        computed: "formatElapsedTime(elapsed)"
      },
      showedElapsedTime: {
        type: Boolean,
        computed: "showElapsedTime(elapsed)"
      },
      showPermalink: {
        type: Boolean,
        value: false
      },
      /**
       * If true, the `warp10-warpscript-ide` component inside this one won't show
       * the plot Button, useful for embedded mode
       */
      hidePlot: {
        type: Boolean,
        value: false
      },
      hidePermalink: {
        type: Boolean,
        computed: "isPermalinkHidden(showPermalink)"
      },
      _baseUrl: {
        type: String,
        computed: "_getBaseUrl(backend,execEndpoint)"
      },
      
      _hasAResponse: {
        type: Boolean,
        value: false
      },
      _hasAnError: {
        type: Boolean,
        value: false
      },

    },
    ready: function() {
    },
    attached: function() {
      editor = this.$.editor;
      editor.addEventListener('editor-content', this.editorChangeAction.bind(this));

      console.debug("[warp10-warpscript-ide] backend before conf", this.backend);
      // Look for a global conf, and apply if it exists
      if (window.quantumConf !== undefined) {
        this.hidePlot = window.quantumConf.embedded;
        this.backend = window.quantumConf.backend;
        this.execEndpoint = window.quantumConf.execEndpoint;
        this.headerName = window.quantumConf.headerName;
      }
      console.debug("[warp10-warpscript-ide] backend after conf", this.backend);

    },
    _getBaseUrl: function() {
      return this.backend + this.execEndpoint;
    },    
    _calcHasAResponse: function() {
      // console.debug("[warp10-warpscript-ide] _calcHasAResponse"); 
    },
    _handleResponse: function(event, response) {      
        if (!response.stack ||
          !response.stack instanceof Array ) {
          this.data = null;
          return;
        }        
        this.elapsed = response.options.elapsed;
        this.data = gtsTools.gtsFromJSONList(response.stack);
        this.stack = response.stack;  
        this._hasAResponse = true;
        this._hasAnError = false;
        
        this.$.response_container.responseChanged();
        
        // console.debug("[warp10-warpscript-ide] _handleResponse", { stack: this.stack, elapsed: this.elapsed, data: this.data });
    },    
    _handleError: function(event, error) {        
        if (error.request.xhr.responseText.match(/<pre>\s*(.*)\s*<\/prse>/)) {
          this.errorMsg = error.request.xhr.responseText.match(/<pre>\s*(.*)\s*<\/prse>/)[1]; 
        } else {
          this.errorMsg =  error.request.statusText;
        }
        
        console.debug("[warp10-warpscript-ide] _handleError", { error: error, errorMsg: this.errorMsg });
        
        this.elapsed = error.elapsed;
        this._hasAResponse = false;
        this._hasAnError = true;       
        
        console.debug("[warp10-warpscript-ide] _handleError - _hasAResponse", this._hasAResponse);
    },
    isPermalinkHidden: function() {
      return !this.showPermalink;
    },
    editorChangeAction: function(value, oldValue) {
      this.content  = value.detail.value;
      // console.debug("[warp10-warpscript-ide] editorChangeAction", this.content);
    },
    hotkeyExecute: function(e) {
      // console.debug("[warp10-warpscript-ide] hotkeyExecute", e.detail.keyboardEvent.target.nodeName)
      var nodeName =  e.detail.keyboardEvent.target.nodeName;
      if ((this.plot ==0) && (nodeName !== 'TEXTAREA') && (nodeName !== 'INPUT')) {
        this.execute();
      }
    },
    hotkeyPlot: function(e) {
      // console.debug("[warp10-warpscript-ide] hotkeyExecute", e.detail.keyboardEvent.target.nodeName)
      var nodeName =  e.detail.keyboardEvent.target.nodeName;
      if ((this.plot ==0) && (nodeName !== 'TEXTAREA') && (nodeName !== 'INPUT')) {
        this.doPlot();
      }
    },
    hotkeyHelp: function(e) {
      var nodeName =  e.detail.keyboardEvent.target.nodeName;
      if ((this.plot ==0) && (nodeName !== 'TEXTAREA') && (nodeName !== 'INPUT')) {
        console.debug("[warp10-warpscript-ide] hotkeyHelp")
        this.$$("#warpscript-ide-keyboard-shortcuts-overlay").open();
      }
    },
    execute: function() {
      console.debug("[warp10-warpscript-ide] Execute", this.content)
      if (this.showPermalink) {
        this.updatePermalink();
      }
      this.warpscriptScript = this.content;
      this.$.warpscriptcaller.generateRequest();    
    },
    doPlot: function() {
      // console.debug([warp10-warpscript-ide] Plot", this.stack)
      if (this.stack.length) {
          this.plot += 1;
          this.target = undefined;
      }
    },
    updatePermalink: function() {
      console.debug("[warp10-warpscript-ide] updatePermalink");
      this.$$("warp10-warpscript-permalink-generator").updatePermalink();
    },
    formatElapsedTime: function() {
      if (this.elapsed < 1000) {
        return ""+this.elapsed+" ns";
      }
      if (this.elapsed < 1000000) {
        return ""+(this.elapsed/1000).toFixed(3)+" μs";
      }
      if (this.elapsed < 1000000000) {
        return ""+(this.elapsed/1000000).toFixed(3)+" ms";
      }
      return ""+(this.elapsed/1000000000).toFixed(3)+" s";
    },
    showElapsedTime: function() {
      if (this.elapsed >0) {
        return true;
      }
      return false;
    }
  })
</script>
