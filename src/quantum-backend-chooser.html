<!--
@author Horacio Gonzalez (@lostinbrittany)
@copyright (c) 2016 Cityzen Data
@license Apache 2.0
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">


<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">

<link rel="import" href="../../bower_components/warp10-iron/warp10-backend-validator.html">

<dom-module id="quantum-backend-chooser">

  <template>

    <style>

      :host {
        display: block;
        --app-primary-color: var(--google-blue-500);
        --app-secondary-color: black;
        --app-background-color: white;
        padding: 15px;
      }

      paper-button {
        background-color: var(--app-primary-color);
        color: var( --app-background-color);
      }

      paper-button[disabled] {
        background-color: var(--google-grey-200) !important;
      }

      .more_info_label {
        float: right;
        cursor: pointer;

      }
      .more_info:after {
          content:'';
          display:block;
          clear: both;
      }
    </style>


    <h4>{{ localize('chooseYourBackend') }}</h4>

    
    <paper-radio-group id="backendRadioGroup" on-iron-select="_backendChoosen" >
      <template is="dom-repeat" items="{{configuredBackends}}" as="item">
        <paper-radio-button data-backend$="{{item}}" name$="{{item.id}}">
          {{item.label}}
        </paper-radio-button>
      </template>
      <paper-radio-button 
          name="chooseAltBackend" checked="{{_chooseAltBackendSelected}}">
        Choose another backend
      </paper-radio-button>
    </paper-radio-group>

    <template is="dom-if" if="{{_chooseAltBackendSelected}}">
      <paper-input
        auto-validate
        prevent-invalid-input 
        name="altBackendUrl" 
        label="{{ localize('backendUrl')}}"
        type="text" 
        value="{{_altBackendUrl}}"
        validator="warp10-backend-validator"
        maxlength="256"
        required ></paper-input>
      <div class="more_info">  
        <div class="more_info_label" on-tap="_toggleOtherParamState">
          <iron-icon icon$="{{_otherParamsStateIcon}}"></iron-icon>
          {{ localize('otherParams') }}
        </div>
      </div>
      <template is="dom-if" if="{{_otherParamsOpen}}">
        <div>            
          <paper-input
            name="altBackendHeader" label="{{ localize('headerName')}}"
            type="text" value="{{_altBackendHeaderName}}"
            required maxlength="64"></paper-input>
          <paper-input
            name="altBackendExecEndpoint" label="{{ localize('execEndpoint')}}"
            type="text" value="{{_altBackendExecEndpoint}}"
            required maxlength="64"></paper-input>  
          <paper-input
            name="altBackendFindEndpoint" label="{{ localize('findEndpoint')}}"
            type="text" value="{{_altBackendFindEndpoint}}"
            required maxlength="64"></paper-input>    
          <paper-input
            name="altBackendUpdateEndpoint" label="{{ localize('updateEndpoint')}}"
            type="text" value="{{_altBackendUpdateEndpoint}}"
            required maxlength="64"></paper-input>   
          <paper-input
            name="altBackendDeleteEndpoint" label="{{ localize('deleteEndpoint')}}"
            type="text" value="{{_altBackendDeleteEndpoint}}"
            required maxlength="64"></paper-input>  
        </div>
      </template>  

      <paper-button  
          name="validateAltBackend" on-tap="_validateAltBackend"
          disabled="{{_invalidAltBackend}}"
          raised>
          <iron-icon icon="done"></iron-icon>
      </paper-button>     
    </template>  

  </template>


  <script>
    Polymer({
      is: "quantum-backend-chooser",    

      behaviors: [
        Polymer.AppLocalizeBehavior     
      ],

      properties: {

        /**
         * The choosen backend
         *  The `backend` object is composed of:
         *
         *  - `id`: an unique id, a simple string to be used as HTML id
         *  - `label`: the label to show in the UI
         *  - `url`: the backend URL
         *  - `execEndpoint`: the path of the WarpScript execution endpoint 
         *  - `findEndpoint`: the path of the Find endpoint
         *  - `updateEndpoint`: the path of the update endpoint
         *  - `deleteEndpoint`: the path of the delete endpoint
         *  - `headerName`: the Warp10 header name to add for different operations
         *
         */        
        backend: {
          type: Object,
          notify: true
        },

        /**
         *  An array of pre-configured `backend` objects.
         *  Example:
         *
         *    [
         *      {
         *        "id": "dist",
         *        "label": "Distributed Warp",
         *        "url": "https://warp.cityzendata.net/dist/api/v0",
         *        "execEndpoint": "/exec",
         *        "findEndpoint": "/find",
         *        "updateEndpoint": "/update",
         *        "deleteEndpoint": "/delete",
         *        "headerName": "Warp10"
         *        }
         *   ]
         *
         */
        configuredBackends: {
          type: Array,
          observer: "_setInitialBackend",
          value: function() {
            return [ ];
          }
        },

        _altBackend: {
          type: Object,
          return: function() {
            return {};
          }
        },

        _otherParamsOpen: {
          type: Boolean,
          value: false
        },
        _otherParamsStateIcon: {
          type: String,
          computed: "_getOtherParamsStateIcon(_otherParamsOpen)"
        },

        _altBackendUrl: {
          type: String,
          value: ""
        },
        _altBackendHeaderName: {
          type: String,
          value: "Warp10"
        },
        _altBackendExecEndpoint: {
          type: String,
          value: "/exec"
        },
        _altBackendFindEndpoint: {
          type: String,
          value: "/find"
        },
        _altBackendUpdateEndpoint: {
          type: String,
          value: "/update"
        },
        _altBackendDeleteEndpoint: {
          type: String,
          value: "/delete"
        },
        _invalidAltBackend: {
          type: Boolean,
          computed: "_isInvalidAltBackend(_altBackendUrl,_altBackendHeaderName,_altBackendExecEndpoint,_altBackendFindEndpoint,_altBackendUpdateEndpoint,_altBackendDeleteEndpoint)"
        },


        /* Overriden from AppLocalizeBehavior */
        language: {
          value: 'en'
        },     
        /* Overriden from AppLocalizeBehavior */
        resources: {
          type: Object,
          value: function() {
            return {
              'en': { 
                'chooseYourBackend': 'Choose your backend',
                'backendUrl': 'Backend URL',
                'otherParams': 'Other backend configuration parameters',
                'headerName': "HTTP header root",
                'execEndpoint': "'Exec' endpoint", 
                'findEndpoint': "'Find' endpoint",
                'updateEndpoint': "'Update' endpoint",  
                'deleteEndpoint': "'Delete' endpoint",
                'validateAltBackend': "Validate",
                'validAltBackend': "Backend configurated"
              },
            }
          }
        }           
      },

      // Observers
      _setInitialBackend: function() {
        // console.debug("[quantum-backend-chooser] _setInitialBackend", this.$.backendRadioGroup.items);
        this.$.backendRadioGroup.selectIndex(0); 
      },

      // Computed properties
      _getOtherParamsStateIcon: function() {
        if (!this._otherParamsOpen) {
          return "arrow-drop-down";
        }
        return "arrow-drop-up";
      },
      _isInvalidAltBackend: function(){ 
        console.debug("[quantum-backend-chooser] _isInvalidAltBackend");
        if (!this._altBackendUrl) return true;
        if (!this._altBackendHeaderName) return true;
        if (!this._altBackendExecEndpoint) return true;
        if (!this._altBackendFindEndpoint) return true;
        if (!this._altBackendUpdateEndpoint) return true;
        if (!this._altBackendDeleteEndpoint) return true;

        var endpoints = [ 
          this._altBackendExecEndpoint, 
          this._altBackendFindEndpoint,
          this._altBackendUpdateEndpoint,
          this._altBackendDeleteEndpoint
          ];
        var unique = function(val, index, self) { 
          return index === self.indexOf(val);
        }  
        var uniqueEndpoints = endpoints.filter(unique);
        console.debug("[quantum-backend-chooser] _isInvalidAltBackend - uniqueEndpoints",uniqueEndpoints);
        
        if (uniqueEndpoints.length != 4) return true;

        return false;
      },

      // Action listeners
      _toggleOtherParamState: function(evt) {
        this._otherParamsOpen = !this._otherParamsOpen;
      },

      _validateAltBackend: function(evt) {
        this._altBackend = {
          url: this._altBackendUrl,
          headerName: this._altBackendHeaderName,
          execEndpoint:this. _altBackendExecEndpoint,
          findEndpoint: this._altBackendFindEndpoint,
          updateEndpoint: this._altBackendUpdateEndpoint,
          deleteEndpoint: this._altBackendDeleteEndpoint
        }
        console.debug("[quantum-backend-chooser] _validateAltBackend", this._altBackend);
        this.backend = this._altBackend;         
      },

      // Event listeners
      _backendChoosen: function(evt, model) {
        var backend = model.item.getAttribute('data-backend');
        if (backend) {
          this.backend = backend;
          console.debug("[quantum-backend-chooser] _backendChoosen - backend", this.backend );
        }
      },

      // Lifecycle methods
      attached: function() {
        this._setInitialBackend();
      }

    });
  </script>
</dom-module>