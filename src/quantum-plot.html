<!--
@author Horacio Gonzalez (@lostinbrittany)
@copyright (c) 2016 Cityzen Data
@license Apache 2.0
-->

<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html">

<link rel="import" href="../bower_components/warp10-iron/warp10-gts-tools.html">
<link rel="import" href="../bower_components/warp10-iron/warp10-simple-overlay.html">
<link rel="import" href="../bower_components/warp10-iron/warp10-warpscript-caller.html">

<link rel="import" href="../bower_components/warp10-quantumviz/warp10-display-alt-chart.html">
<link rel="import" href="../bower_components/warp10-quantumviz/quantumviz-annotations.html">


<link rel="import" href="../bower_components/granite-alert/granite-alert.html">
<link rel="import" href="../bower_components/granite-spinner/granite-spinner.html">

<link rel="import" href="./quantum-gts-tree.html">
<link rel="import" href="./quantum-image-overlay.html">
<link rel="import" href="./quantum-module-behavior.html">

<!--
Warp plot widget

    <quantum-plot
        warpscript="{{warpscript}}"
        backend="{{backend}}"
        data="{{data}}">
    </quantum-plot>
-->

<dom-module id="quantum-plot">
  <template>
    <style>
      :host {
        display: block;
        padding: 15px;
        --app-primary-color: var(--google-blue-500);
        --app-secondary-color: black;
        --app-background-color: white;
        --app-on-background-color: white;
      }
      #vertGuide {
        width:0px;
        height: 100%;
        border: solid 1px #aaaaaa;
        z-index: 500;
        position: absolute;
        left: 250px;
        display: none;
      }
      .overlayGtsSelectorBox, .overlayGtsRegexBox {
        display:flex;
        flex-flow: row;
        justify-content: center;
      }
      .overlayGtsSelector, .overlayGtsRegex  {
      }
      .overlayBox {
        display:flex;
        flex-flow: row;
        justify-content: center;
        font-size: 1.2em;
      }
      .overlayContent  {
      }
      .hotkey-key {
        background-color: #333;
        border: 1px solid #333;
        border-radius: 5px;
        box-shadow: 0 1px 0 #666 inset, 0 1px 0 #bbb;
        color: #fff;
        display: inline-block;
        font-size: 1em;
        margin-right: 5px;
        padding: 5px 9px;
        text-align: center;
      }
    </style>

    <iron-a11y-keys id="hotkeyUp" target="[[_target]]" keys="k up"     on-keys-pressed="_hotkeyUp"  ></iron-a11y-keys>
    <iron-a11y-keys id="hotkeyDown"  target="[[_target]]" keys="j down"   on-keys-pressed="_hotkeyDown"></iron-a11y-keys>
    <iron-a11y-keys target="[[_target]]" keys="space"    on-keys-pressed="_hotkeySpace"></iron-a11y-keys>
    <iron-a11y-keys target="[[_target]]" keys="a"        on-keys-pressed="_hotkeyAll"></iron-a11y-keys>
    <iron-a11y-keys target="[[_target]]" keys="n"        on-keys-pressed="_hotkeyNone"></iron-a11y-keys>
    <iron-a11y-keys target="[[_target]]" keys="r"        on-keys-pressed="_hotkeyReload"></iron-a11y-keys>
    <iron-a11y-keys target="[[_target]]" keys="/ help:keypress"  on-keys-pressed="_hotkeyRegex" ></iron-a11y-keys>
    <iron-a11y-keys target="[[_target]]" keys="enter"  on-keys-pressed="_hotkeyRegexEnter"></iron-a11y-keys>
    <iron-a11y-keys target="[[_target]]" keys="h ?:keypress"     on-keys-pressed="_hotkeyHelp"></iron-a11y-keys>

    <warp10-simple-overlay id="warpscript-plot-keyboard-shortcuts-overlay">
      <div class="overlay-box">
        <h4>Keyboard Shortcuts:</h4>
        <p><span class="hotkey-key">?</span> Show / hide this help menu</p>
        <p><span class="hotkey-key">r</span> Reload data</p>
        <p><span class="hotkey-key">k</span>, <span class="hotkey-key">up</span> Selection up</p>
        <p><span class="hotkey-key">j</span>, <span class="hotkey-key">down</span> Selection down</p>
        <p><span class="hotkey-key">space</span> Select/unselect</p>
        <p><span class="hotkey-key">a</span> Select all</p>
        <p><span class="hotkey-key">n</span> Select none</p>
        <p><span class="hotkey-key">/</span> Select by regex</p>
      </div>
    </warp10-simple-overlay> 


    <quantum-image-overlay id="image-overlay"></quantum-image-overlay>

    <granite-spinner
        active="{{loading}}" 
        size="200"
        hover></granite-spinner>

   <quantum-gts-tree 
      id="gts-tree" 
      data="{{data}}" 
      plotted-changed={{changed}}></quantum-gts-tree>

    
    <div id="vertGuide"></div>

    <quantumviz-annotations
      id="warp10-quantumviz-annotations"
      time-bounds="{{timeBounds}}"
      chart-area="{{chartArea}}"
      data="{{dataToPlot}}"
      vert-guide="{{vertGuide}}"
      width="{{_displayWidth}}"
      selected-timestamp="{{annotationsSelectedTimestamp}}"
      >
    </quantumviz-annotations>
    
    <warp10-display-chart
        id="warp10-display-chart"
        width="{{_displayWidth}}"
        height="500"
        data="{{dataToPlot}}"
        current-values="{{currentValues}}"
        time-bounds="{{timeBounds}}"
        chart-area="{{chartArea}}"
        ></warp10-display-chart>
    

    <warp10-simple-overlay id="gts-select-overlay">
      <div class="overlayGtsSelectorBox">
        <div class="overlayGtsSelector">
          <template is="dom-repeat" items="{{stackedGtsListSlidingWindow}}" as="gts">
            <quantum-gts-in-selection-overlay
                gts="{{gts}}"
                stacked-gts-list="{{stackedGtsList}}"
                selected-gts="{{selectedGts}}"
                changed="{{changed}}"></quantum-gts-in-selection-overlay>
          </template>
        </div>
      </div>
    </warp10-simple-overlay>

    <warp10-simple-overlay id="gtsRegexOverlay">
      <div class="overlayGtsRegexBox">
        <div class="overlayGtsRegex">
          <div>Regex selector</div>
          <input autofocus id="regexInput" value="{{_currentRegex::input}}">
          <div class="btn btn-primary" on-click="selectRegex">Select</div>
        </div>
      </div>
    </warp10-simple-overlay>

    <warp10-warpscript-caller
        id="warpscriptcaller"
        url="{{_baseUrl}}" warpscript="{{warpscript}}"
        on-response="_handleResponse"  on-error="_handleError"
        loading="{{loading}}"></warp10-warpscript-caller>


  </template>

  <script>
    Polymer({
      is: "quantum-plot",
      behaviors: [
        QuantumModule
      ],
      properties: { 
        /**
         * The data to plot
         */
        data: {
          type: Array,
          observer: "_onDataChanged"
        },
        /**
         * The WarpScript generating the data to plot
         */        
        warpscript: {
          type: String
        },
        _target: {
          type: Object,
          value: function() {
            return document.body;
          }
        },
        vertGuide: {
          type: Number,
          observer: '_onVertGuideChanged'
        },
        selectedGts: {
          type: Number,
          value: -1
        },
        stackedGtsList: {
          type: Array
        },
        stackedGtsListSlidingWindow: {
          type: Array,
          computed: "getStackedGtsListSlidingWindow(stackedGtsList, selectedGts)"
        },

        _currentRegex: {
          type: String,
          observer: "_onCurrentRegexChanged"
        },

        _baseUrl: {
          type: String,
          computed: "_getBaseUrl(backend)"
        },        
      },

      listeners: {
        'plotted-changed': '_onPlottedChanged'
      },

      /**************************************************************************/
      /* Lifecycle methods                                                      */
      /**************************************************************************/
      ready: function() {
      },      
      attached: function() {
        console.debug("[quantum-warpscript-plot] attached - target", this._target)
        this.init();
        this.dataToPlot = [];
        console.debug("[quantum-warpscript-plot] attached - this", this)
        this.$.gtsRegexOverlay.addEventListener('iron-overlay-closed', this._hideRegexOverlay.bind(this));
        this.$.gtsRegexOverlay.addEventListener('iron-overlay-opened', this._regexModeOpened.bind(this));        
        
        // console.debug("[quantum-warpscript-plot] attached - width", this.offsetWidth)
        this._displayWidth = this.offsetWidth;
      },

      /**************************************************************************/
      /* Computed properties                                                    */
      /**************************************************************************/
      _getBaseUrl: function() {
        return this.backend.url + this.backend.execEndpoint;
      },

      /**************************************************************************/
      /* Observers                                                              */
      /**************************************************************************/
      _onVertGuideChanged: function(event) {
        if (this.vertGuide >0) {
          this.$.vertGuide.style.display = "inline-block";
          this.$.vertGuide.style.left = this.vertGuide+"px";
        } else {
          this.$.vertGuide.style.display = "none";
        }
      },
      _onDataChanged: function() {
        console.debug("[warp10-warpscript-plot] _onDataChanged", this.data);
        if (this.data !== null) {
          console.debug("[warp10-warpscript-plot] _onDataChanged - do refresh");
          plottingTools.refresh(gtsTools.flattenGtsIdArray(this.data));
          this.stackedGtsList = gtsTools.flattenGtsIdArray(this.data, []);
        }
      },
      _onCurrentRegexChanged: function() {
        if (!this._regexModeJustOpened) {
          return;
        }
        this._regexModeJustOpened = false;
        // console.debug("[warp10-warpscript-plot] _onCurrentRegexChanged");
        this._currentRegex = this._currentRegex.substring(0, this._currentRegex.length - 1);
        this.$$("#regexInput").select();
      },

      /**************************************************************************/
      /* Event Listeners                                                        */
      /**************************************************************************/
      _handleResponse: function(event, response) {      
        if (!response.stack ||
          !response.stack instanceof Array ) {
          this._dataToPlot = null;
          return;
        }      
        this.data = gtsTools.gtsFromJSONList(response.stack);        
      }, 
      _onPlottedChanged: function(evt) {        
        this.dataToPlot = [{ 
          gts: evt.detail.data,
          params: evt.detail.params,
          globalParams: {}
        }];
        console.debug("[quantum-warpscript-plot] plottedChanged", this.dataToPlot);
        
        this.$$('#warp10-display-chart').dataChanged();
        this.$$("#warp10-quantumviz-annotations").dataChanged();
        // console.debug("[quantum-warpscript-plot] plottedChanged", e.detail);
      },

      _regexModeOpened: function(evt) {
        this._regexModeJustOpened = true;
      },
      _showSelectionOverlay: function(evt) {
        this.selectedMode = true;
        this.$$('#gts-select-overlay').open();
        this.overlay.timerActivate();
      },
      _showRegexOverlay: function(evt) {
        this._regexMode = true;
        this._regexJustShown = true;
        this.$.gtsRegexOverlay.open();
      },
      _hideSelectionOverlay: function(evt) {
        this.selectedMode = false;
        this.$$('#gts-select-overlay').close()
      },
      _hideRegexOverlay: function(evt) {
        this._regexMode = false;
        this.$.gtsRegexOverlay.close();
      },             

      /**************************************************************************/
      /* Other methods                                                          */
      /**************************************************************************/
      init: function() {
        console.debug("[quantum-warpscript-plot] attached() - this.data", this.data);

        this.stackedGtsListHalfLimit = 3;

        this.stackedGtsList = gtsTools.flattenGtsIdArray(this.data, []);
        // console.debug("[quantum-warpscript-plot] attached() - stackedGtsList", this.stackedGtsList);

        // Overlay conf for selection TO-DO
        this.overlay = {};
        this.overlay.lifetime = 5000;
        this.overlay.timer = null;
        this.overlay.timerActivate = function(overlay) {
          if (this.overlay.timer != null) {
            window.clearTimeout(this.overlay.timer);
          }
          this.overlay.timer = window.setTimeout(function() {
            this._hideSelectionOverlay();
          }.bind(this), this.overlay.lifetime);
        }.bind(this);


      },  

      getStackedGtsListSlidingWindow: function() {
        var windowEnd, windowInit;
        if (this.stackedGtsList.length < (1 + 2 * this.stackedGtsListHalfLimit)) {
          return this.stackedGtsList;
        }
        if (this.selectedGts < this.stackedGtsListHalfLimit) {
          windowInit = 0;
          windowEnd = 2 * this.stackedGtsListHalfLimit;
        } else {
          if (this.selectedGts > this.stackedGtsList.length - this.stackedGtsListHalfLimit - 1) {
            windowInit = this.stackedGtsList.length - 1 - 2 * this.stackedGtsListHalfLimit;
            windowEnd = this.stackedGtsList.length - 1;
          } else {
            windowInit = this.selectedGts - this.stackedGtsListHalfLimit;
            windowEnd = this.selectedGts + this.stackedGtsListHalfLimit;
          }
        }
        return this.stackedGtsList.slice(windowInit, windowEnd + 1);
      },

      selectRegex: function() {
        var gts, i, len, ref;
        // console.debug("[quantum-warpscript-plot] selectRegex called with regex", "/" + this._currentRegex + "/");
        ref = this.stackedGtsList;
        for (i = 0, len = ref.length; i < len; i++) {
          gts = ref[i];
          if (gtsTools.serializeGtsMetadata(gts).match("" + this._currentRegex)) {
            // console.debug("[quantum-warpscript-plot] gts selected by regex", gtsTools.serializeGtsMetadata(gts))
            // TO-DO this.addToPlot(gts);
            plottingTools.add(gts);
          }
        }
        this.changed++;
        this.fire('plotted-changed', plottingTools);
        this._hideRegexOverlay();
      },



      /**************************************************************************/
      /* Hotkeys                                                                */
      /**************************************************************************/  
      _hotkeyUp: function(e) {
        console.debug("[quantum-warpscript-plot] _hotkey up");
        if (this.plot > 0 && !this._regexMode) {
          // console.debug([quantum-warpscript-plot] _hotkey up");
          this._showSelectionOverlay();
          if ((this.selectedGts == null) || this.selectedGts < 0) {
            this.selectedGts = 0;
          }
          if (this.selectedGts > 0) {
            this.selectedGts -= 1;
          }
        }
      },
      _hotkeyDown: function(e) {
        if (this.plot > 0 && !this._regexMode) {
          // console.debug([quantum-warpscript-plot] _hotkey down");
          this._showSelectionOverlay();
          if ((this.selectedGts == null) || this.selectedGts < 0) {
            this.selectedGts = 0;
          } else {
            if (this.stackedGtsList.length > this.selectedGts + 1) {
              this.selectedGts += 1;
              // console.debug("length " + this.stackedGtsList.length + " selected " + this.selectedGts);
            }
          }
        }
      },
      _hotkeyRegex: function(e) {
        if (this.plot > 0) {
          // console.debug("[quantum-warpscript-plot] _hotkeyRegex");
          this._showRegexOverlay();
        }
      },
      _hotkeyRegexEnter: function(e) {
        if (this.plot > 0 && this._regexMode) {
          // console.debug("[quantum-warpscript-plot] _hotkeyRegexEnter");
          this.selectRegex();
        }
      },
      _hotkeySpace: function(e) {
        // console.debug("[quantum-warpscript-plot] _hotkeySpace");
        if (this.plot > 0 && !this._regexMode) {
          this._showSelectionOverlay();
          if (this.selectedGts < 0) {
            this.selectedGts = 0;
          }
          var gts = this.stackedGtsList[this.selectedGts];
          if (!plottingTools.isPlotted(gts)) {
            plottingTools.add(gts);
            // console.debug("[quantum-warpscript-plot] addToPlot", plottingTools);
          } else {
            plottingTools.remove(gts);
            // console.debug("[quantum-warpscript-plot] removeFromPlot", plottingTools);
          }
          this.changed++;
          this.fire('plotted-changed', plottingTools);
          //return this.switchPlotState(this.getStackedGtsList[this.selectedGts]);
        }
      },
      _hotkeyAll: function(e) {
        if (this.plot > 0 && !this._regexMode) {
          // console.debug("[quantum-warpscript-plot] _hotkeyAll")
          for (var i in this.stackedGtsList) {
              var gts = this.stackedGtsList[i];
              if (!plottingTools.isPlotted(gts)) {
                plottingTools.add(gts);
                // console.debug("[quantum-warpscript-plot] addToPlot", plottingTools);
              }
          }
          this.changed++;
          this.fire('plotted-changed', plottingTools);
        }
      },
      _hotkeyNone: function(e) {
        if (this.plot > 0 && !this._regexMode) {
          // console.debug("[quantum-warpscript-plot] _hotkeyNone")
          for (var i in this.stackedGtsList) {
              var gts = this.stackedGtsList[i];
              if (plottingTools.isPlotted(gts)) {
                plottingTools.remove(gts);
                // console.debug("[quantum-warpscript-plot] removeFromPlot", plottingTools);
              }
          }
          this.changed++;
          this.fire('plotted-changed', plottingTools);
        }
      },
      _hotkeyReload: function(e) {
        if (this.plot > 0 && !this._regexMode) {
          // console.debug([quantum-warpscript-plot] _hotkey r");
          this.$.warpscriptcaller.generateRequest();    
        }
      },
      _hotkeyHelp: function(e) {
        if (this.plot > 0 && !this._regexMode) {
          // console.debug("[quantum-warpscript-plot] _hotkeyHelp")
          this.$$("#warpscript-plot-keyboard-shortcuts-overlay").open();
        }
      }, 


    });
  </script>
</dom-module>

<!--
  /******************************************************************************/
  /******************************************************************************/
-->

<dom-module id="quantum-gts-in-selection-overlay">
  <template>
    <style>
      :host {
        display: block;
      }
      div {
        padding:10px;
      }
      .color-dot {
        border-radius: 50%;
        background-color: #bbbbbb;
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-left: 5px;
        margin-right: 5px;
      }
      .gts-classname {
        color: #174771;
      }
      .gts-labelname {
        color: #2c5e48;
      }
      .gts-separator {
        color: #777777;
      }
      .gts-labelvalue {
        color: #333333;
        font-style: italic;
      }

    </style>

    <div style$="{{selectedStyle}}">
      <span class="color-dot" style$="{{color}}"></span>
      <span class='gts-classname'>{{gts.c}}</span>
      <span class='gts-separator'>{</span>
      <template is="dom-repeat" items="{{_toArray(gts.l)}}" as="label">
        <spam>
          <span class='gts-labelname'>{{label.name}}</span>
          <span class='gts-separator'>=</span>
          <span class='gts-labelvalue'>{{label.value}}</span>
          <span  hidden$="{{_lastIndex(index, gts.l)}}">,</span>
        </span>
      </template>
      <span class='gts-separator'>}</span>
    </div>
  </template>

  <script>
    Polymer({
      is: "quantum-gts-in-selection-overlay",
      properties: {
        gts: {
          type: Object
        },
        stackedGtsList: {
          type: Array
        },
        selectedGts: {
          type: Number
        },
        selectedStyle: {
          type: Object,
          computed: "setSelectedStyle(selectedGts, gts, stackedGtsList)"
        },
        changed: {
          type: Number
        },
        color: {
          type: String,
          computed: "setColor(selectedGts,gts, changed)"
        }
      },
      setColor: function(){
        // console.debug([quantum-gts-in-selection-overlay] setColor", plottingTools.gtsColor(this.gts));
        return plottingTools.gtsColor(this.gts);
      },
      setSelectedStyle: function() {
        // console.debug("[quantum-gts-in-selection-overlay] setSelectedStyle - selectedGts",this.selectedGts);
        // console.debug("[quantum-gts-in-selection-overlay] setSelectedStyle - gts",this.gts);
        // console.debug("[quantum-gts-in-selection-overlay] setSelectedStyle - stackedGtsList",this.stackedGtsList);
        if (this.selectedGts < 0) {
          return "";
        }
        if (this.stackedGtsList[this.selectedGts].id === this.gts.id) {
          // console.debug("[quantum-warpscript-plot] Selected gts", this.gts.id);
          return "background-color:rgba(200,200,200,0.5);";
        }
        return "";
      },
      _toArray: function(obj) {
        return Object.keys(obj).map(function(key) {
          return {
            name: key,
            value: obj[key]
          };
        });
      },
      _lastIndex: function(index, obj) {
        var array = this._toArray(obj)
        return (index == array.length -1)
      },
      _stringify: function(obj) {
        return(JSON.stringify(obj));
      }
    });
  </script>
</dom-module>