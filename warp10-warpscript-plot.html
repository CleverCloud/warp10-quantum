<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../warp10-quantum/warp10-gts-tree.html">
<link rel="import" href="../warp10-quantum/warp10-plot-gts.html">
<link rel="import" href="../warp10-quantum/warp10-image-overlay.html">
<link rel="import" href="../warp10-iron/warp10-gts-tools.html">
<link rel="import" href="../warp10-iron/warp10-simple-overlay.html">
<link rel="import" href="../warp10-iron/warp10-warpscript-caller.html">
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">
<link   rel="import" href="../warp10-quantum/quantum-external-deps.html">

<dom-module id="warp10-warpscript-plot">
  <template>
    <style>
      :host {
        display: block;
      }
      .overlayGtsSelectorBox, .overlayGtsRegexBox {
        display:flex;
        flex-flow: row;
        justify-content: center;
      }
      .overlayGtsSelector, .overlayGtsRegex  {
      }
      .overlayBox {
        display:flex;
        flex-flow: row;
        justify-content: center;
        font-size: 1.2em;
      }
      .overlayContent  {
      }
      .hotkey-key {
        background-color: #333;
        border: 1px solid #333;
        border-radius: 5px;
        box-shadow: 0 1px 0 #666 inset, 0 1px 0 #bbb;
        color: #fff;
        display: inline-block;
        font-size: 1em;
        margin-right: 5px;
        padding: 5px 9px;
        text-align: center;
      }
    </style>


    <iron-a11y-keys target="[[target]]" keys="k up"     on-keys-pressed="hotkeyUp"  ></iron-a11y-keys>
    <iron-a11y-keys target="[[target]]" keys="j down"   on-keys-pressed="hotkeyDown"></iron-a11y-keys>
    <iron-a11y-keys target="[[target]]" keys="space"    on-keys-pressed="hotkeySpace"></iron-a11y-keys>
    <iron-a11y-keys target="[[target]]" keys="a"        on-keys-pressed="hotkeyAll"></iron-a11y-keys>
    <iron-a11y-keys target="[[target]]" keys="n"        on-keys-pressed="hotkeyNone"></iron-a11y-keys>
    <iron-a11y-keys target="[[target]]" keys="r"        on-keys-pressed="hotkeyReload"></iron-a11y-keys>
    <iron-a11y-keys target="[[target]]" keys="/ help:keypress"  on-keys-pressed="hotkeyRegex" ></iron-a11y-keys>
    <iron-a11y-keys target="[[target]]" keys="enter"  on-keys-pressed="hotkeyRegexEnter"></iron-a11y-keys>
    <iron-a11y-keys target="[[target]]" keys="h ?:keypress"     on-keys-pressed="hotkeyHelp"></iron-a11y-keys>
    <warp10-simple-overlay id="warpscript-plot-keyboard-shortcuts-overlay">
      <div class="overlay-box">
        <h4>Keyboard Shortcuts:</h4>
        <p><span class="hotkey-key">?</span> Show / hide this help menu</p>
        <p><span class="hotkey-key">r</span> Reload data</p>
        <p><span class="hotkey-key">k</span>, <span class="hotkey-key">up</span> Selection up</p>
        <p><span class="hotkey-key">j</span>, <span class="hotkey-key">down</span> Selection down</p>
        <p><span class="hotkey-key">space</span> Select/unselect</p>
        <p><span class="hotkey-key">a</span> Select all</p>
        <p><span class="hotkey-key">n</span> Select none</p>
        <p><span class="hotkey-key">/</span> Select by regex</p>
      </div>
    </warp10-simple-overlay>

    <warp10-image-overlay id="image-overlay"></warp10-image-overlay>

    <spinner-widget active="{{loading}}" hover size="200" ></spinner-widget>
    <warp10-gts-tree id="gts-tree" data="{{data}}" new-data="{{newData}}" plotted-changed={{changed}}></warp10-gts-tree>
    <warp10-plot-gts
      height = "500"
      show-axis="true"  tooltip="true" line-width="2" reload="0"
      data="{{dataToPlot}}" new-data="{{newData}}">
    </warp10-plot-gts>

    <warp10-simple-overlay id="gts-select-overlay">
      <div class="overlayGtsSelectorBox">
        <div class="overlayGtsSelector">
          <template is="dom-repeat" items="{{stackedGtsListSlidingWindow}}" as="gts">
            <warp10-gts-in-selection-overlay
              gts="{{gts}}"
              stacked-gts-list="{{stackedGtsList}}"
              selected-gts="{{selectedGts}}"
              changed="{{changed}}">
            </warp10-gts-in-selection-overlay>
          </template>
        </div>
      </div>
    </warp10-simple-overlay>

    <warp10-simple-overlay id="gts-regex-overlay">
      <div class="overlayGtsRegexBox">
        <div class="overlayGtsRegex">
          <div>Regex selector</div>
          <input autofocus id="regexInput" value="{{_currentRegex::input}}">
          <div class="btn btn-primary" on-click="selectRegex">Select</div>
        </div>
      </div>
    </warp10-simple-overlay>


    <warp10-warpscript-caller
      id="warpscript-caller"
      base-url="{{_baseUrl}}" warpscript="{{warpscript}}"
      data="{{response}}"    loading="{{loading}}" call="{{call}}"
      error="{{error}}" error-msg="{{errorMsg}}" >
    </warp10-warpscript-caller>

  </template>
</dom-module>

<script>
  Polymer({
    is: "warp10-warpscript-plot",
    properties: {
      data: {
        type: Array,
        observer: "dataChanged"
      },
      warpscript: {
        type: String
      },
      target: {
        type: Object,
        value: function() {
          return document.body;
        }
      },
      backend: {
        type: String,
        value: "http://127.0.0.1:8080/api/v0"
      },
      /**
       * The  exec endpoint
       */
      execEndpoint: {
        type: String,
        value: "/exec"
      },
      response: {
        type: Array,
        observer: "responseChanged"
      },
      selectedGts: {
        type: Number,
        value: -1
      },
      stackedGtsList: {
        type: Array
      },
      stackedGtsListSlidingWindow: {
        type: Array,
        computed: "getStackedGtsListSlidingWindow(stackedGtsList, selectedGts)"
      },
      call: {
        type: Number,
        value: 0
      },
      _baseUrl: {
        type: String,
        computed: "_getBaseUrl(backend,execEndpoint)"
      },
      _currentRegex: {
        type: String,
        observer: "_currentRegexChanged"
      }
    },
    listeners: {
      'plotted-changed': 'plottedChanged'
    },
    attached: function() {
      this.init();
      this.newData = 0;
      /*
      document.addEventListener('plotted-changed', function (e) {
        this.dataToPlot = e.detail;
        this.newData++;
        console.debug(e.detail);
      }.bind(this));
      */
      this.$$('#gts-regex-overlay').addEventListener('iron-overlay-closed', this.hideRegexOverlay.bind(this));
      this.$$('#gts-regex-overlay').addEventListener('iron-overlay-opened', this._regexModeOpened.bind(this));
    },
    _regexModeOpened: function(e) {
      this._regexModeJustOpened = true;
    },
    _currentRegexChanged: function() {
      if (!this._regexModeJustOpened) {
        return;
      }
      this._regexModeJustOpened = false;
      console.debug("[warp10-warpscript-plot] _currentRegexChanged");
      this._currentRegex = this._currentRegex.substring(0, this._currentRegex.length - 1);
    },
    _getBaseUrl: function() {
      return this.backend + this.execEndpoint;
    },
    dataChanged: function() {
      console.debug("[warp10-warpscript-plot] dataChanged", this.data);
      if (this.data !== null) {
        console.debug("[warp10-warpscript-plot] dataChanged - do refresh");
        plottingTools.refresh(gtsTools.flattenGtsIdArray(this.data));
        this.stackedGtsList = gtsTools.flattenGtsIdArray(this.data, []);
        this.newData ++;
      }
    },
    responseChanged: function() {
      // console.debug([warp10-warpscript-plot] responseChanged", { response: this.response });
      if (this.response !== null) {
          this.data = gtsTools.gtsFromJSONList(this.response);
      } else {
        this.data = null;
      }
    },
    plottedChanged: function(e) {
      this.dataToPlot = e.detail;
      this.newData++;
      // console.debug("[warp10-warpscript-plot] plotedChanged", e.detail);
    },
    init: function() {
      // console.debug("[warp10-warpscript-plot attached() - this.data", this.data);

      this.stackedGtsListHalfLimit = 3;

      this.stackedGtsList = gtsTools.flattenGtsIdArray(this.data, []);
      console.debug("[warp10-warpscript-plot] attached() - stackedGtsList", this.stackedGtsList);

      // Overlay conf for selection TO-DO
      this.overlay = {};
      this.overlay.lifetime = 5000;
      this.overlay.timer = null;
      this.overlay.timerActivate = function(overlay) {
        if (this.overlay.timer != null) {
          window.clearTimeout(this.overlay.timer);
        }
        this.overlay.timer = window.setTimeout(function() {
          this.hideSelectionOverlay();
        }.bind(this), this.overlay.lifetime);
      }.bind(this);
    },
    getStackedGtsListSlidingWindow: function() {
      var windowEnd, windowInit;
      if (this.stackedGtsList.length < (1 + 2 * this.stackedGtsListHalfLimit)) {
        return this.stackedGtsList;
      }
      if (this.selectedGts < this.stackedGtsListHalfLimit) {
        windowInit = 0;
        windowEnd = 2 * this.stackedGtsListHalfLimit;
      } else {
        if (this.selectedGts > this.stackedGtsList.length - this.stackedGtsListHalfLimit - 1) {
          windowInit = this.stackedGtsList.length - 1 - 2 * this.stackedGtsListHalfLimit;
          windowEnd = this.stackedGtsList.length - 1;
        } else {
          windowInit = this.selectedGts - this.stackedGtsListHalfLimit;
          windowEnd = this.selectedGts + this.stackedGtsListHalfLimit;
        }
      }
      return this.stackedGtsList.slice(windowInit, windowEnd + 1);
    },
    selectRegex: function() {
      var gts, i, len, ref;
      console.debug("[warp10-warpscript-plot] selectRegex called with regex", "/" + this._currentRegex + "/");
      ref = this.stackedGtsList;
      for (i = 0, len = ref.length; i < len; i++) {
        gts = ref[i];
        if (gtsTools.serializeGtsMetadata(gts).match("" + this._currentRegex)) {
          // console.debug("[warp10-warpscript-plot] gts selected by regex", gtsTools.serializeGtsMetadata(gts))
          // TO-DO this.addToPlot(gts);
          plottingTools.add(gts);
        }
      }
      this.changed++;
      this.fire('plotted-changed', plottingTools);
      this.hideRegexOverlay();
    },
    showSelectionOverlay: function(e) {
      this.selectedMode = true;
      this.$$('#gts-select-overlay').open();
      this.overlay.timerActivate();
    },
    showRegexOverlay: function(e) {
      this._regexMode = true;
      this._regexJustShown = true;
      this.$$('#gts-regex-overlay').open();
    },
    hideSelectionOverlay: function(e) {
      this.selectedMode = false;
      this.$$('#gts-select-overlay').close()
    },
    hideRegexOverlay: function(e) {
      this._regexMode = false;
      this.$$('#gts-regex-overlay').close();
    },

    hotkeyUp: function(e) {
      if (this.plot > 0 && !this._regexMode) {
        // console.debug([warp10-warpscript-plot] hotkey up");
        this.showSelectionOverlay();
        if ((this.selectedGts == null) || this.selectedGts < 0) {
          this.selectedGts = 0;
        }
        if (this.selectedGts > 0) {
          this.selectedGts -= 1;
        }
      }
    },
    hotkeyDown: function(e) {
      if (this.plot > 0 && !this._regexMode) {
        // console.debug([warp10-warpscript-plot] hotkey down");
        this.showSelectionOverlay();
        if ((this.selectedGts == null) || this.selectedGts < 0) {
          this.selectedGts = 0;
        } else {
          if (this.stackedGtsList.length > this.selectedGts + 1) {
            this.selectedGts += 1;
            console.debug("length " + this.stackedGtsList.length + " selected " + this.selectedGts);
          }
        }
      }
    },
    hotkeyRegex: function(e) {
      if (this.plot > 0) {
        console.debug("[warp10-warpscript-plot] hotkeyRegex");
        this.showRegexOverlay();
      }
    },
    hotkeyRegexEnter: function(e) {
      if (this.plot > 0 && this._regexMode) {
        console.debug("[warp10-warpscript-plot] hotkeyRegexEnter");
        this.selectRegex();
      }
    },
    hotkeySpace: function(e) {
      if (this.plot > 0 && !this._regexMode) {
        this.showSelectionOverlay();
        if (this.selectedGts < 0) {
          this.selectedGts = 0;
        }
        var gts = this.stackedGtsList[this.selectedGts];
        if (!plottingTools.isPlotted(gts)) {
          plottingTools.add(gts);
          console.debug("[warp10-warpscript-plot] addToPlot", plottingTools);
        } else {
          plottingTools.remove(gts);
          console.debug("[warp10-warpscript-plot] removeFromPlot", plottingTools);
        }
        this.changed++;
        this.fire('plotted-changed', plottingTools);
        //return this.switchPlotState(this.getStackedGtsList[this.selectedGts]);
      }
    },
    hotkeyAll: function(e) {
      if (this.plot > 0 && !this._regexMode) {
        console.debug("[warp10-warpscript-plot] hotkeyAll")
        for (var i in this.stackedGtsList) {
            var gts = this.stackedGtsList[i];
            if (!plottingTools.isPlotted(gts)) {
              plottingTools.add(gts);
              console.debug("[warp10-warpscript-plot] addToPlot", plottingTools);
            }
        }
        this.changed++;
        this.fire('plotted-changed', plottingTools);
      }
    },
    hotkeyNone: function(e) {
      if (this.plot > 0 && !this._regexMode) {
        console.debug("[warp10-warpscript-plot] hotkeyNone")
        for (var i in this.stackedGtsList) {
            var gts = this.stackedGtsList[i];
            if (plottingTools.isPlotted(gts)) {
              plottingTools.remove(gts);
              console.debug("[warp10-warpscript-plot] removeFromPlot", plottingTools);
            }
        }
        this.changed++;
        this.fire('plotted-changed', plottingTools);
      }
    },
    hotkeyReload: function(e) {
      if (this.plot > 0 && !this._regexMode) {
        // console.debug([warp10-warpscript-plot] hotkey r");
        this.call++;
      }
    },
    hotkeyHelp: function(e) {
      if (this.plot > 0 && !this._regexMode) {
        console.debug("[warp10-warpscript-plot] hotkeyHelp")
        this.$$("#warpscript-plot-keyboard-shortcuts-overlay").open();
      }
    },
  });
</script>


/******************************************************************************/
/******************************************************************************/


<dom-module id="warp10-gts-in-selection-overlay">
  <template>
    <style>
      :host {
        display: block;
      }
      div {
        padding:10px;
      }
      .color-dot {
        border-radius: 50%;
        background-color: #bbbbbb;
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-left: 5px;
        margin-right: 5px;
      }
      .gts-classname {
        color: #174771;
      }
      .gts-labelname {
        color: #2c5e48;
      }
      .gts-separator {
        color: #777777;
      }
      .gts-labelvalue {
        color: #333333;
        font-style: italic;
      }

    </style>

    <div style$="{{selectedStyle}}">
      <span class="color-dot" style$="{{color}}"></span>
      <span class='gts-classname'>{{gts.c}}</span>
      <span class='gts-separator'>{</span>
      <template is="dom-repeat" items="{{_toArray(gts.l)}}" as="label">
        <spam>
          <span class='gts-labelname'>{{label.name}}</span>
          <span class='gts-separator'>=</span>
          <span class='gts-labelvalue'>{{label.value}}</span>
          <span  hidden$="{{_lastIndex(index, gts.l)}}">,</span>
        </span>
      </template>
      <span class='gts-separator'>}</span>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: "warp10-gts-in-selection-overlay",
    properties: {
      gts: {
        type: Object
      },
      stackedGtsList: {
        type: Array
      },
      selectedGts: {
        type: Number
      },
      selectedStyle: {
        type: Object,
        computed: "setSelectedStyle(selectedGts, gts, stackedGtsList)"
      },
      changed: {
        type: Number
      },
      color: {
        type: String,
        computed: "setColor(selectedGts,gts, changed)"
      }
    },
    setColor: function(){
      // console.debug([warp10-gts-in-selection-overlay] setColor", plottingTools.gtsColor(this.gts));
      return plottingTools.gtsColor(this.gts);
    },
    setSelectedStyle: function() {
      // console.debug("[warp10-gts-in-selection-overlay] setSelectedStyle - selectedGts",this.selectedGts);
      // console.debug("[warp10-gts-in-selection-overlay] setSelectedStyle - gts",this.gts);
      // console.debug("[warp10-gts-in-selection-overlay] setSelectedStyle - stackedGtsList",this.stackedGtsList);
      if (this.selectedGts < 0) {
        return "";
      }
      if (this.stackedGtsList[this.selectedGts].id === this.gts.id) {
        console.debug("[warp10-warpscript-plot] Selected gts", this.gts.id);
        return "background-color:rgba(200,200,200,0.5);";
      }
      return "";
    },
    _toArray: function(obj) {
      return Object.keys(obj).map(function(key) {
        return {
          name: key,
          value: obj[key]
        };
      });
    },
    _lastIndex: function(index, obj) {
      var array = this._toArray(obj)
      return (index == array.length -1)
    },
    _stringify: function(obj) {
      return(JSON.stringify(obj));
    }
  });
</script>
